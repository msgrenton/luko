    <script>
        // --- FOOTER YEAR ---
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // --- CONFIG ---
        const PREVIEW_URL = '/api/preview-total';
        const CREATE_INVOICE_URL = '/api/create-invoice';

        // --- SCROLL HELPER ---
        function scrollToOrder() {
            document.getElementById('order').scrollIntoView({ behavior: 'smooth' });
        }

        // --- URL PARAM CHECK (Success/Fail) ---
        function checkUrlStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const modal = document.getElementById('status-modal');
            const title = document.getElementById('modal-title');
            const text = document.getElementById('modal-text');

            if (status === 'success') {
                modal.style.display = 'flex';
                title.textContent = 'Order Confirmed';
                title.style.color = 'var(--success)';
                text.textContent = 'Thank you. Your payment has been detected. We will begin production immediately. Please check your email for confirmation.';
                
                // Reset cart visuals
                document.getElementById('qty_black').value = 0;
                document.getElementById('qty_gold').value = 0;
                renderEmptyState(); // Sync to 0
            } else if (status === 'fail') {
                modal.style.display = 'flex';
                title.textContent = 'Payment Failed';
                title.style.color = 'var(--error)';
                text.textContent = 'The payment process was cancelled or failed. Your order has not been finalized. Please try again.';
                
                // Scroll to order form to try again
                scrollToOrder();
            }
        }

        function closeModal() {
            document.getElementById('status-modal').style.display = 'none';
            // Clear URL params
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        window.addEventListener('load', () => {
            checkUrlStatus();
            // Initial render based on default values (usually 1 black, 0 gold)
            if (getTotalQuantity() > 0) {
                fetchPreview();
            } else {
                renderEmptyState();
            }
        });

        // HERO VARIANT UI
        document.querySelectorAll('.variant-opt').forEach(opt => {
            opt.addEventListener('click', function() {
                document.querySelectorAll('.variant-opt').forEach(o => o.classList.remove('active'));
                this.classList.add('active');

                const val = this.getAttribute('data-value');
                const priceEl = document.querySelector('.hero-price');
                if (val === 'Black Edition') {
                    priceEl.textContent = 'Black Edition — 400 USDT • worldwide shipping included';
                } else if (val === 'Gold Edition') {
                    priceEl.textContent = 'Gold Edition — 600 USDT • worldwide shipping included';
                }
            });
        });

        // --- SERVER-SIDE PRICING LOGIC ---
        
        let debounceTimer;

        function getTotalQuantity() {
            const qtyBlack = parseInt(document.getElementById('qty_black').value) || 0;
            const qtyGold = parseInt(document.getElementById('qty_gold').value) || 0;
            return qtyBlack + qtyGold;
        }

        function getItemsFromDOM() {
            const qtyBlack = parseInt(document.getElementById('qty_black').value) || 0;
            const qtyGold = parseInt(document.getElementById('qty_gold').value) || 0;
            
            const items = [];
            if (qtyBlack > 0) items.push({ variant: 'Black Edition', quantity: qtyBlack });
            if (qtyGold > 0) items.push({ variant: 'Gold Edition', quantity: qtyGold });
            
            return items;
        }

        function updateItemQty(id, delta) {
            const el = document.getElementById('qty_' + id);
            let val = parseInt(el.value) || 0;
            val += delta;
            if (val < 0) val = 0;
            if (val > 10) val = 10;
            el.value = val;
            
            // Immediate trigger (no debounce on clicks)
            if (getTotalQuantity() === 0) {
                renderEmptyState();
            } else {
                fetchPreview();
            }
        }

        // Rule A: Empty Cart State (Frontend Only)
        function renderEmptyState() {
            const totalEl = document.getElementById('finalPrice');
            const promoVal = document.getElementById('promo').value.trim();
            
            let msg = '';
            // Rule A3: Neutral helper message if text exists
            if (promoVal.length > 0) {
                 msg = '<div style="font-size:0.8rem; color:#888; margin-top:0.3rem;">Add items to apply a code.</div>';
            }
            
            // Rule A1: Always 0.00
            totalEl.innerHTML = `0.00 USDT${msg}`;
        }

        async function fetchPreview() {
            // Guard: If empty, do not call worker (Rule A4)
            if (getTotalQuantity() === 0) {
                renderEmptyState();
                return;
            }

            const items = getItemsFromDOM();
            const promo = document.getElementById('promo').value.trim();
            const totalEl = document.getElementById('finalPrice');

            try {
                const response = await fetch(PREVIEW_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items, promo })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    let discountHtml = '';
                    
                    // Rule B2 Logic
                    if (data.discount_applied) {
                        discountHtml = '<div style="font-size:0.8rem; color:var(--success); margin-top:0.3rem;">PROMO APPLIED</div>';
                    } else if (promo.length > 0) {
                        // If promo has text but discount NOT applied -> Red Invalid
                        discountHtml = '<div style="font-size:0.8rem; color:var(--error); margin-top:0.3rem;">INVALID PROMO</div>';
                    } 
                    // Else if promo empty -> no status (default behavior of empty string)

                    totalEl.innerHTML = `${data.final_amount.toFixed(2)} USDT${discountHtml}`;
                }
            } catch (e) {
                console.error("Pricing preview failed", e);
            }
        }

        // Promo Input Listener
        document.getElementById('promo').addEventListener('input', () => {
            clearTimeout(debounceTimer);
            
            if (getTotalQuantity() === 0) {
                // Rule A: Immediate local update for empty cart (to show/hide helper msg)
                renderEmptyState();
            } else {
                // Rule B: Debounce 700ms for active cart
                debounceTimer = setTimeout(fetchPreview, 700);
            }
        });

        // CAROUSEL
        const track = document.querySelector('.carousel-track');
        const slides = Array.from(track.children);
        const nextBtn = document.querySelector('.nav-btn.next');
        const prevBtn = document.querySelector('.nav-btn.prev');
        let currentSlide = 0;

        function moveToSlide(index) {
            if (index < 0) index = slides.length - 1;
            if (index >= slides.length) index = 0;
            track.style.transform = 'translateX(-' + (index * 100) + '%)';
            currentSlide = index;
        }

        nextBtn.addEventListener('click', () => moveToSlide(currentSlide + 1));
        prevBtn.addEventListener('click', () => moveToSlide(currentSlide - 1));
        
        let touchStartX = 0;
        let touchEndX = 0;

        track.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        track.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            if (touchStartX - touchEndX > 50) moveToSlide(currentSlide + 1);
            if (touchEndX - touchStartX > 50) moveToSlide(currentSlide - 1);
        }

        // FORM SUBMIT
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const overlay = document.getElementById('loading-overlay');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            const items = getItemsFromDOM();

            if (items.length === 0) {
                alert("Please select at least one item.");
                return;
            }

            overlay.style.display = 'flex';
            submitBtn.disabled = true;

            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                items: items, // Sending items, not total
                address: {
                    line1: document.getElementById('address_line1').value,
                    line2: document.getElementById('address_line2').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value,
                    country: document.getElementById('country').value
                },
                promo: document.getElementById('promo').value,
                note: document.getElementById('note').value
            };

            try {
                const response = await fetch(CREATE_INVOICE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    let errorMsg = 'Server error';
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) errorMsg = errorData.error;
                    } catch (_) {}
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                if (data.invoice_url) {
                    window.location.href = data.invoice_url;
                } else {
                    throw new Error("No invoice URL returned");
                }

            } catch (err) {
                alert('Error creating order: ' + err.message);
                overlay.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    </script>
